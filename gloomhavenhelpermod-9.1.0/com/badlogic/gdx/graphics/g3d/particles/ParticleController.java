package com.badlogic.gdx.graphics.g3d.particles;

import com.badlogic.gdx.Gdx;
import com.badlogic.gdx.assets.AssetManager;
import com.badlogic.gdx.graphics.g3d.particles.emitters.Emitter;
import com.badlogic.gdx.graphics.g3d.particles.influencers.Influencer;
import com.badlogic.gdx.graphics.g3d.particles.renderers.ParticleControllerRenderer;
import com.badlogic.gdx.math.Matrix4;
import com.badlogic.gdx.math.Quaternion;
import com.badlogic.gdx.math.Vector3;
import com.badlogic.gdx.math.collision.BoundingBox;
import com.badlogic.gdx.utils.Array;
import com.badlogic.gdx.utils.Json;
import com.badlogic.gdx.utils.JsonValue;
import com.badlogic.gdx.utils.reflect.ClassReflection;

public class ParticleController implements Json.Serializable, ResourceData.Configurable {
   protected static final float DEFAULT_TIME_STEP = 0.016666668F;
   public String name;
   public Emitter emitter;
   public Array influencers;
   public ParticleControllerRenderer renderer;
   public ParallelArray particles;
   public ParticleChannels particleChannels;
   public Matrix4 transform = new Matrix4();
   public Vector3 scale = new Vector3(1.0F, 1.0F, 1.0F);
   protected BoundingBox boundingBox;
   public float deltaTime;
   public float deltaTimeSqr;

   public ParticleController() {
      this.influencers = new Array(true, 3, Influencer.class);
      this.setTimeStep(0.016666668F);
   }

   public ParticleController(String name, Emitter emitter, ParticleControllerRenderer renderer, Influencer... influencers) {
      this();
      this.name = name;
      this.emitter = emitter;
      this.renderer = renderer;
      this.particleChannels = new ParticleChannels();
      this.influencers = new Array(influencers);
   }

   private void setTimeStep(float timeStep) {
      this.deltaTime = timeStep;
      this.deltaTimeSqr = this.deltaTime * this.deltaTime;
   }

   public void setTransform(Matrix4 transform) {
      this.transform.set(transform);
      transform.getScale(this.scale);
   }

   public void setTransform(float x, float y, float z, float qx, float qy, float qz, float qw, float scale) {
      this.transform.set(x, y, z, qx, qy, qz, qw, scale, scale, scale);
      this.scale.set(scale, scale, scale);
   }

   public void rotate(Quaternion rotation) {
      this.transform.rotate(rotation);
   }

   public void rotate(Vector3 axis, float angle) {
      this.transform.rotate(axis, angle);
   }

   public void translate(Vector3 translation) {
      this.transform.translate(translation);
   }

   public void setTranslation(Vector3 translation) {
      this.transform.setTranslation(translation);
   }

   public void scale(float scaleX, float scaleY, float scaleZ) {
      this.transform.scale(scaleX, scaleY, scaleZ);
      this.transform.getScale(this.scale);
   }

   public void scale(Vector3 scale) {
      this.scale(scale.x, scale.y, scale.z);
   }

   public void mul(Matrix4 transform) {
      this.transform.mul(transform);
      this.transform.getScale(this.scale);
   }

   public void getTransform(Matrix4 transform) {
      transform.set(this.transform);
   }

   public boolean isComplete() {
      return this.emitter.isComplete();
   }

   public void init() {
      this.bind();
      if (this.particles != null) {
         this.end();
         this.particleChannels.resetIds();
      }

      this.allocateChannels(this.emitter.maxParticleCount);
      this.emitter.init();

      for (Influencer influencer : this.influencers) {
         influencer.init();
      }

      this.renderer.init();
   }

   protected void allocateChannels(int maxParticleCount) {
      this.particles = new ParallelArray(maxParticleCount);
      this.emitter.allocateChannels();

      for (Influencer influencer : this.influencers) {
         influencer.allocateChannels();
      }

      this.renderer.allocateChannels();
   }

   protected void bind() {
      this.emitter.set(this);

      for (Influencer influencer : this.influencers) {
         influencer.set(this);
      }

      this.renderer.set(this);
   }

   public void start() {
      this.emitter.start();

      for (Influencer influencer : this.influencers) {
         influencer.start();
      }
   }

   public void reset() {
      this.end();
      this.start();
   }

   public void end() {
      for (Influencer influencer : this.influencers) {
         influencer.end();
      }

      this.emitter.end();
   }

   public void activateParticles(int startIndex, int count) {
      this.emitter.activateParticles(startIndex, count);

      for (Influencer influencer : this.influencers) {
         influencer.activateParticles(startIndex, count);
      }
   }

   public void killParticles(int startIndex, int count) {
      this.emitter.killParticles(startIndex, count);

      for (Influencer influencer : this.influencers) {
         influencer.killParticles(startIndex, count);
      }
   }

   public void update() {
      this.update(Gdx.graphics.getDeltaTime());
   }

   public void update(float deltaTime) {
      this.setTimeStep(deltaTime);
      this.emitter.update();

      for (Influencer influencer : this.influencers) {
         influencer.update();
      }
   }

   public void draw() {
      if (this.particles.size > 0) {
         this.renderer.update();
      }
   }

   public ParticleController copy() {
      Emitter emitter = (Emitter)this.emitter.copy();
      Influencer[] influencers = new Influencer[this.influencers.size];
      int i = 0;

      for (Influencer influencer : this.influencers) {
         influencers[i++] = (Influencer)influencer.copy();
      }

      return new ParticleController(new String(this.name), emitter, (ParticleControllerRenderer)this.renderer.copy(), influencers);
   }

   public void dispose() {
      this.emitter.dispose();

      for (Influencer influencer : this.influencers) {
         influencer.dispose();
      }
   }

   public BoundingBox getBoundingBox() {
      if (this.boundingBox == null) {
         this.boundingBox = new BoundingBox();
      }

      this.calculateBoundingBox();
      return this.boundingBox;
   }

   protected void calculateBoundingBox() {
      this.boundingBox.clr();
      ParallelArray.FloatChannel positionChannel = (ParallelArray.FloatChannel)this.particles.getChannel(ParticleChannels.Position);
      int pos = 0;

      for (int c = positionChannel.strideSize * this.particles.size; pos < c; pos += positionChannel.strideSize) {
         this.boundingBox.ext(positionChannel.data[pos + 0], positionChannel.data[pos + 1], positionChannel.data[pos + 2]);
      }
   }

   private int findIndex(Class type) {
      for (int i = 0; i < this.influencers.size; i++) {
         Influencer influencer = (Influencer)this.influencers.get(i);
         if (ClassReflection.isAssignableFrom(type, influencer.getClass())) {
            return i;
         }
      }

      return -1;
   }

   public Influencer findInfluencer(Class influencerClass) {
      int index = this.findIndex(influencerClass);
      return index > -1 ? (Influencer)this.influencers.get(index) : null;
   }

   public void removeInfluencer(Class type) {
      int index = this.findIndex(type);
      if (index > -1) {
         this.influencers.removeIndex(index);
      }
   }

   public boolean replaceInfluencer(Class type, Influencer newInfluencer) {
      int index = this.findIndex(type);
      if (index > -1) {
         this.influencers.insert(index, newInfluencer);
         this.influencers.removeIndex(index + 1);
         return true;
      } else {
         return false;
      }
   }

   @Override
   public void write(Json json) {
      json.writeValue("name", this.name);
      json.writeValue("emitter", this.emitter, Emitter.class);
      json.writeValue("influencers", this.influencers, Array.class, Influencer.class);
      json.writeValue("renderer", this.renderer, ParticleControllerRenderer.class);
   }

   @Override
   public void read(Json json, JsonValue jsonMap) {
      this.name = (String)json.readValue("name", String.class, jsonMap);
      this.emitter = (Emitter)json.readValue("emitter", Emitter.class, jsonMap);
      this.influencers.addAll((Array)json.readValue("influencers", Array.class, Influencer.class, jsonMap));
      this.renderer = (ParticleControllerRenderer)json.readValue("renderer", ParticleControllerRenderer.class, jsonMap);
   }

   @Override
   public void save(AssetManager manager, ResourceData data) {
      this.emitter.save(manager, data);

      for (Influencer influencer : this.influencers) {
         influencer.save(manager, data);
      }

      this.renderer.save(manager, data);
   }

   @Override
   public void load(AssetManager manager, ResourceData data) {
      this.emitter.load(manager, data);

      for (Influencer influencer : this.influencers) {
         influencer.load(manager, data);
      }

      this.renderer.load(manager, data);
   }
}
